# TARGET時系列オッズ自動取得 - フロー構造設計

## 📋 実際の操作手順（ユーザー提供）

```
1. ターゲットを起動
2. 成績ボタンを押下
3. タブにて開催名を押下
4. 取得希望の年を選択（例：2025年）
5. 取得希望の開催日の開催会場をダブルクリック
6. 取得希望のレース名をダブルクリック
7. オッズボタンを押下
8. 単複時系　タブを押下
9. JVオッズ取得ボタン押下
10. 上部ファイルを押下（又は ALT+F）
11. テキストファイル出力　押下
12. 単複時系列オッズCSV形式　押下
13. 単複時系列オッズCSV形式 の出力が終了しましたのポップをOKを押す
14. 画面上部　閉じるボタンを2回押下

→ 6に戻り、次のレースを選択（12レースまで）
→ 12レースまでやったら、5に戻る（次の開催日）
```

## 🔄 フロー構造（2重ループ）

### 全体構造

```
┌─────────────────────────────────────────┐
│ 初期化                                   │
│ - TARGET起動                            │
│ - 成績ボタン → 開催名タブ               │
│ - 年選択（例: 2025年）                  │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ 【外側ループ】開催日ループ               │
│ For Each 開催日 in 開催日リスト          │
│                                         │
│  ├─ 開催会場をダブルクリック（ステップ5）│
│  │                                      │
│  ├─┌───────────────────────────────┐  │
│  │ │【内側ループ】レースループ         │  │
│  │ │For RaceIndex = 1 to 12           │  │
│  │ │                                  │  │
│  │ │ ├─ レース名をダブルクリック（6）  │  │
│  │ │ ├─ オッズボタン押下（7）         │  │
│  │ │ ├─ 単複時系タブ押下（8）         │  │
│  │ │ ├─ JVオッズ取得（9）            │  │
│  │ │ ├─ 待機（30秒）                 │  │
│  │ │ ├─ ALT+F（10）                  │  │
│  │ │ ├─ テキストファイル出力（11）    │  │
│  │ │ ├─ 単複時系列CSV形式（12）      │  │
│  │ │ ├─ OKボタン押下（13）           │  │
│  │ │ └─ 閉じる×2回（14）             │  │
│  │ │                                  │  │
│  │ └───────────────────────────────┘  │
│  │                                      │
│  └─ 次の開催日へ                         │
│                                         │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ 終了処理                                 │
│ - TARGET終了                            │
│ - 出力検証                              │
└─────────────────────────────────────────┘
```

## 💡 実装可能性: 100%可能！

### 理由

1. **明確な手順**: 全ステップが具体的に定義されている
2. **繰り返しパターン**: ループ構造が明確
3. **Power Automate対応**: 2重ループは標準機能で実装可能

## 🎯 実装アプローチ

### Phase 1: 1レース分を記録（最小単位）

**記録する範囲:**
- ステップ6-14（レース選択～閉じる）

**記録時の注意:**
- **1番目のレース**を選択
- ゆっくり操作
- 各ステップ後に少し待機

### Phase 2: レースループ化（内側ループ）

**変換作業:**
1. 記録したアクション（ステップ6-14）を選択
2. 「ループで囲む」→ Loop（1 to 12）
3. レース選択を動的化:
   ```
   修正前: 1番目のレースをダブルクリック
   修正後: %RaceIndex%番目のレースをダブルクリック
   ```

### Phase 3: 開催日ループ化（外側ループ）

**変換作業:**
1. レースループ全体を選択
2. 「ループで囲む」→ For Each（開催日リスト）
3. 開催日選択を動的化

## 📝 変数設計

### 入力変数

| 変数名 | 型 | 説明 | 例 |
|--------|-----|------|-----|
| `Year` | Text | 取得年 | "2025" |
| `VenueList` | List | 開催会場リスト | ["中京", "東京", "阪神"] |
| `RaceCount` | Number | 1開催日のレース数 | 12 |

### ループ変数

| 変数名 | 型 | 説明 |
|--------|-----|------|
| `CurrentVenue` | Text | 現在処理中の開催会場 |
| `RaceIndex` | Number | 現在のレース番号（1-12） |

## ⏱️ 所要時間見積もり

### 1レースあたり
- JVオッズ取得: 20-30秒
- CSV出力: 5秒
- 画面遷移: 5秒
- **合計: 約30-40秒**

### 1開催日（12レース）
- 12レース × 40秒 = **約8分**

### 1日分（3開催）
- 3開催 × 8分 = **約24分**

### 1ヶ月分（30日、3開催/日）
- 30日 × 24分 = **約12時間**
- → 夜間自動実行で対応

## 🚀 実装手順（ステップバイステップ）

### ステップ1: Power Automate起動

```powershell
start ms-powerautomate://
```

### ステップ2: 新しいフロー作成

1. 「新しいフロー」
2. フロー名: `TARGET時系列オッズ自動取得（2重ループ版）`

### ステップ3: 初期化部分を記録

**デスクトップレコーダー起動**

記録内容:
1. TARGET起動
2. 成績ボタン押下
3. 開催名タブ押下
4. 年選択（2025年を選択）

**レコーダー停止**

### ステップ4: 1開催日・1レース分を記録

**デスクトップレコーダー再起動**

記録内容:
5. **1番目の開催会場**をダブルクリック
6. **1番目のレース**をダブルクリック
7. オッズボタン押下
8. 単複時系タブ押下
9. JVオッズ取得ボタン押下
10. 待機（30秒程度）
11. ALT+F（またはファイルメニュー）
12. テキストファイル出力
13. 単複時系列オッズCSV形式
14. OKボタン
15. 閉じるボタン×2回

**レコーダー停止**

### ステップ5: レースループ化

1. ステップ6-14を選択
2. 右クリック → 「ループで囲む」
3. ループ設定:
   - 種類: **Loop**
   - 開始: `1`
   - 終了: `12`
   - インデックス: `%RaceIndex%`

4. レース選択アクションを編集:
   - セレクターのインデックスを `%RaceIndex%` に変更

### ステップ6: 開催日ループ化

1. ステップ5（開催会場選択）+ レースループ全体を選択
2. 右クリック → 「ループで囲む」
3. ループ設定:
   - 種類: **For Each**
   - リスト: `%VenueList%`
   - 現在の項目: `%CurrentVenue%`

4. 開催会場選択アクションを編集:
   - `%CurrentVenue%` を使用

### ステップ7: 変数追加

入力変数:
- `Year`: "2025"
- `VenueList`: ["中京", "東京", "阪神"]（または手動で追加）

### ステップ8: テスト実行

**小規模テスト:**
1. VenueList = ["中京"]（1開催のみ）
2. RaceCount = 2（2レースのみ）
3. 実行して動作確認

**本番テスト:**
1. VenueList = ["中京"]
2. RaceCount = 12
3. 実行

**フル実行:**
1. VenueList = ["中京", "東京", "阪神"]
2. RaceCount = 12
3. 実行

## 💡 実装のコツ

### 1. 待機時間の調整

各操作後に適切な待機を追加:
```
- オッズボタン押下後: 2秒
- JVオッズ取得後: 30秒（重要！）
- CSV出力後: 3秒
- 閉じる後: 2秒
```

### 2. エラーハンドリング

Try-Catchで囲む:
```
Try:
  - レース処理
Catch:
  - エラーログ記録
  - スクリーンショット保存
  - 次のレースへ継続
```

### 3. セレクターの動的化

**レース選択:**
```
修正前: <row index='1' />
修正後: <row index='%RaceIndex%' />
```

**開催会場選択:**
```
修正前: <cell text='中京' />
修正後: <cell text='%CurrentVenue%' />
```

## 🎓 高度な実装（オプション）

### 開催日の自動取得

手動でVenueListを指定する代わりに:
1. 開催日一覧のUI要素を取得
2. 要素数をカウント
3. For Eachで処理

### 日付範囲指定

年だけでなく、日付範囲を指定:
- StartDate: 2025/01/01
- EndDate: 2025/01/31

## ⚠️ 注意事項

### JVオッズ取得の待機時間

- **最も重要な待機**
- レースによって取得時間が異なる
- 30秒で足りない場合は60秒に延長

### レース数の変動

- 通常は12レース
- 特別開催では異なる場合あり
- エラーハンドリングで対応

### CSV出力先

- TARGET環境設定で出力先を確認
- `C:\Users\takuy\Desktop\投資競馬アプリ系\target系\output` を推奨

## 📞 次のステップ

1. **ステップ3-4を実行**: 初期化 + 1レース分を記録
2. 動作確認
3. ステップ5-6でループ化
4. テスト実行

---

**結論: 完全に自動化可能です！** 2重ループ構造ですが、Power Automate for Desktopの標準機能で実装できます。
