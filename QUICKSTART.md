# 🚀 TARGET自動化 - クイックスタートガイド（2重ループ版）

## ✅ 結論: 完全に自動化可能です！

提供いただいた14ステップの操作手順は、Power Automate for Desktopの**2重ループ機能**で完全に自動化できます。

## 📊 フロー構造

```
開催日ループ（外側）
  └─ レースループ（内側: 1-12レース）
       └─ 1レースの処理（14ステップ）
```

## ⏱️ 所要時間見積もり

- **1レース**: 約30-40秒
- **1開催日（12レース）**: 約8分
- **1日分（3開催）**: 約24分

## 🎯 実装手順（3ステップで完成）

### ステップ1: 1レース分を記録（10分）

1. **Power Automate起動**
   ```powershell
   start ms-powerautomate://
   ```

2. **新しいフロー作成**
   - フロー名: `TARGET時系列オッズ自動取得`

3. **デスクトップレコーダー起動 → 記録開始**

4. **以下を記録（ゆっくり操作）:**
   ```
   ✓ 1. TARGETを起動
   ✓ 2. 成績ボタン押下
   ✓ 3. 開催名タブ押下
   ✓ 4. 2025年を選択
   ✓ 5. 1番目の開催会場をダブルクリック
   ✓ 6. 1番目のレースをダブルクリック
   ✓ 7. オッズボタン押下
   ✓ 8. 単複時系タブ押下
   ✓ 9. JVオッズ取得ボタン押下
   ✓ 10. 待機（30秒程度待つ）
   ✓ 11. ALT+F（またはファイルメニュー）
   ✓ 12. テキストファイル出力
   ✓ 13. 単複時系列オッズCSV形式
   ✓ 14. OKボタン押下
   ✓ 15. 閉じるボタン×2回
   ```

5. **レコーダー停止**

### ステップ2: ループ化（10分）

#### 2-0. 開催日の自動取得（重要！）

**開催数（2開催、3開催など）を自動判定:**

1. **「UI要素を検索」アクションを追加**
   - 左パネル「アクション」→「UI オートメーション」→「UI要素を検索」
   - ステップ4（年選択）の直後に追加

2. **設定:**
   - UI要素: 開催日一覧の親要素を選択
   - 検索条件: 全ての子要素（行）
   - 結果を格納: `%VenueElements%`

これで、画面上の全ての開催会場（中山、阪神、中京など）が自動的にリストとして取得されます。

#### 2-1. レースループ（内側）

1. **ステップ6-15を選択**（レース選択～閉じる）
2. 右クリック → **「ループで囲む」**
3. ループ設定:
   - 種類: **Loop**
   - 開始: `1`
   - 終了: `12`
   - インデックス: `RaceIndex`

4. **レース選択を動的化**
   - 「6. レースをダブルクリック」アクションを編集
   - UI要素セレクターのインデックスを `%RaceIndex%` に変更

#### 2-2. 開催日ループ（外側）

1. **ステップ5 + レースループ全体を選択**
2. 右クリック → **「ループで囲む」**
3. ループ設定:
   - 種類: **For Each**
   - リスト: `VenueList`（後で作成）
   - 現在の項目: `CurrentVenue`

4. **入力変数を追加**
   - 左パネル「変数」→「+」→「入力変数」
   - 変数名: `VenueList`
   - データ型: **List**
   - 既定値: `["中京"]`（テスト用に1つだけ）

### ステップ3: テスト実行（5分）

1. **小規模テスト**
   - VenueList = `["中京"]`（1開催のみ）
   - レースループを `1 to 2` に変更（2レースのみ）
   - **実行ボタン**クリック

2. **動作確認**
   - 自動で操作されることを確認
   - 出力フォルダにCSVが生成されることを確認

3. **本番設定**
   - レースループを `1 to 12` に戻す
   - VenueList = `["中京", "東京", "阪神"]`

## 💡 重要なポイント

### 1. JVオッズ取得後の待機（最重要）

ステップ9の後、**必ず30秒以上待機**してください。
- レコーダーで記録時: 実際に30秒待つ
- または、記録後に「待機」アクションを手動追加

### 2. セレクターの動的化

**レース選択（ステップ6）:**
```
修正前: <row index='1' />
修正後: <row index='%RaceIndex%' />
```

**開催会場選択（ステップ5）:**
```
修正前: <cell text='中京' />
修正後: <cell text='%CurrentVenue%' />
```

### 3. エラーハンドリング

レースループ全体をTry-Catchで囲む:
- エラー時: ログ記録 → 次のレースへ継続

## 📂 出力先設定

TARGET環境設定で出力先を確認:
```
C:\Users\takuy\Desktop\投資競馬アプリ系\target系\output
```

## 🎓 詳細ドキュメント

より詳しい説明は以下を参照:
- **FLOW_STRUCTURE.md** - フロー構造の詳細設計
- **rpa/FLOW_DESIGN.md** - Power Automate設計書

## ⚠️ トラブルシューティング

### UI要素が見つからない
- TARGETウィンドウを最大化して記録
- セレクターを画像認識に切り替え

### 待機時間が足りない
- JVオッズ取得後の待機を60秒に延長

### レース数が12でない場合
- エラーハンドリングで対応
- または、レース数を変数化

## 📞 次のアクション

**今すぐ実行:**
```powershell
start ms-powerautomate://
```

**ステップ1から始めてください！**

---

**所要時間: 合計25分で完成**
- 記録: 10分
- ループ化: 10分
- テスト: 5分
