# TARGET自動化 - ループ処理版ガイド

## 🔄 各レースを個別処理する場合の実装方法

TARGETで各レースを1つずつクリックして処理する必要がある場合、Power Automate for Desktopの**ループ機能**を使用します。

## � 実装アプローチ

### 方法A: UI要素リストでループ（推奨）

#### メリット
- レース数を自動判定
- 柔軟性が高い
- レース数が変わっても対応可能

#### 実装手順

1. **レース一覧のUI要素を取得**
   ```
   アクション: UI要素を検索
   - 検索対象: レース一覧の各行
   - 結果: %RaceElements% (リスト変数)
   ```

2. **For Eachループで処理**
   ```
   アクション: For Each
   - 値: %RaceElements%
   - 現在の項目: %CurrentRace%
   
   ループ内:
     1. %CurrentRace% をクリック
     2. 時系列オッズダウンロード
     3. CSV出力
     4. 「戻る」または「閉じる」
   ```

### 方法B: 固定回数ループ（シンプル）

#### メリット
- 実装が簡単
- 動作が安定

#### デメリット
- レース数を手動指定

#### 実装手順

1. **入力変数の追加**
   ```
   変数名: RaceCount
   データ型: Number
   既定値: 12
   説明: 処理するレース数
   ```

2. **Forループで処理**
   ```
   アクション: Loop
   - 開始値: 1
   - 終了値: %RaceCount%
   - 増分: 1
   - ループインデックス: %LoopIndex%
   
   ループ内:
     1. レース一覧の%LoopIndex%番目をクリック
     2. 時系列オッズダウンロード
     3. CSV出力
     4. 「戻る」または「閉じる」
   ```

## 🎯 推奨実装: 方法B（固定回数ループ）

初回実装は**方法B**が簡単で確実です。

### ステップバイステップ

#### Phase 1: 1レース分を記録

1. **デスクトップレコーダー起動**
2. **1レース分の操作を記録:**
   - 検索結果の**1番目のレース**をクリック
   - 時系列オッズダウンロード
   - CSV出力
   - 「戻る」ボタンで検索結果に戻る
3. **レコーダー停止**

#### Phase 2: ループに変換

1. **記録したアクションを選択**
   - 「レースをクリック」から「戻る」までを選択

2. **ループで囲む**
   - 右クリック → 「ループで囲む」
   - ループの種類: **Loop**
   - 開始値: `1`
   - 終了値: `%RaceCount%`（入力変数）

3. **レースクリックを動的に変更**
   - 「レースをクリック」アクションを編集
   - セレクターを修正して `%LoopIndex%` 番目を選択

#### Phase 3: 変数追加

1. **入力変数を追加**
   ```
   StartDate: Text (例: 2024/12/01)
   EndDate: Text (例: 2024/12/01)
   RaceCount: Number (例: 12)
   ```

## 💡 実装のコツ

### 1. セレクターの動的化

レース一覧の各行には通常、インデックスや順序番号があります。

**例: セレクターの修正**
```
修正前: <row index='1' />
修正後: <row index='%LoopIndex%' />
```

### 2. 待機時間の追加

各処理の後に待機を追加:
```
- レースクリック後: 2秒待機
- ダウンロード後: 30秒待機（レースにより調整）
- CSV出力後: 3秒待機
- 戻る後: 2秒待機
```

### 3. エラーハンドリング

ループ内を Try-Catch で囲む:
```
Try:
  - レース処理
Catch:
  - エラーログ記録
  - スクリーンショット保存
  - 次のレースへ継続（または中断）
```

## 📝 フロー構造例

```
1. 変数初期化
   - StartDate, EndDate, RaceCount

2. TARGET起動

3. レース検索
   - 日付範囲入力
   - 検索実行

4. ループ処理（1 to RaceCount）
   ┌─────────────────────────────┐
   │ 4-1. N番目のレースをクリック  │
   │ 4-2. 待機（2秒）             │
   │ 4-3. 時系列オッズDL          │
   │ 4-4. 待機（30秒）            │
   │ 4-5. CSV出力                │
   │ 4-6. 待機（3秒）             │
   │ 4-7. 戻るボタンクリック       │
   │ 4-8. 待機（2秒）             │
   └─────────────────────────────┘

5. TARGET終了（オプション）

6. 出力検証
```

## 🚀 実装手順（修正版）

### ステップ1: 1レース分を記録

```powershell
# Power Automate起動
start ms-powerautomate://
```

1. 新しいフロー作成: `TARGET時系列オッズ自動取得（ループ版）`
2. デスクトップレコーダー起動
3. **以下を記録:**
   - TARGET起動
   - レース検索（日付: 2024/12/01固定）
   - 検索実行
   - **1番目のレース**をクリック
   - 時系列オッズダウンロード
   - CSV出力
   - **戻る**ボタンクリック

### ステップ2: ループに変換

1. フローデザイナーで、「レースクリック」から「戻る」までを選択
2. 右クリック → 「ループで囲む」
3. ループ設定:
   - 種類: **Loop**
   - 開始: `1`
   - 終了: `12`（後で変数化）

### ステップ3: セレクターを動的化

1. 「レースをクリック」アクションをダブルクリック
2. UI要素セレクターを編集
3. インデックス部分を `%LoopIndex%` に変更

### ステップ4: 変数化

1. 入力変数を追加:
   - `StartDate`: Text
   - `EndDate`: Text
   - `RaceCount`: Number (既定値: 12)

2. 日付入力部分を変数に置き換え

### ステップ5: テスト実行

1. RaceCount = 2 で実行（2レース分のみ）
2. 動作確認
3. 問題なければ RaceCount = 12 で実行

## ⚠️ 注意事項

### レース数の指定

- 1日分の場合: 通常36レース（3場×12R）
- 特定の場のみ: 12レース
- **RaceCount を正確に指定**しないと、存在しないレースをクリックしてエラー

### 所要時間

- 1レースあたり: 約30-60秒（ダウンロード時間による）
- 12レース: 約6-12分
- 36レース: 約18-36分

## 🎓 高度な実装（オプション）

### レース数の自動判定

```
1. 検索結果画面でレース一覧のUI要素を取得
2. 要素数をカウント → %RaceCount%
3. For Each ループで処理
```

この方法なら、レース数を手動指定する必要がありません。

## 📞 次のステップ

1. **まず1レース分を記録**してみてください
2. 動作確認後、ループ化します
3. 不明点があればお知らせください

---

**重要:** 各レースを個別処理する必要がある場合でも、Power Automate for Desktopのループ機能で完全自動化可能です！
