# Power Automate for Desktop フロー設計書

## フロー名
TARGET時系列オッズ自動取得

## 概要
TARGETソフトウェアから指定期間の時系列オッズデータを自動取得し、CSV形式で出力する。

## 前提条件
- TARGETがインストールされている
- Power Automate for Desktopがインストールされている（Windows 10/11標準）
- TARGET環境設定で「時系列オッズCSV形式出力用フォルダ」が設定されている

## 入力変数

| 変数名 | 型 | 説明 | 例 |
|--------|-----|------|-----|
| StartDate | Text | 開始日（YYYY/MM/DD） | 2024/01/01 |
| EndDate | Text | 終了日（YYYY/MM/DD） | 2024/01/31 |
| TargetExePath | Text | TARGET実行ファイルパス | C:\Program Files\TARGET\target.exe |
| OutputFolder | Text | CSV出力先フォルダ | C:\Users\takuy\Desktop\投資競馬アプリ系\target系\output |

## フロー手順

### 1. 初期化
```
アクション: 変数の設定
- StartDate = %StartDate%
- EndDate = %EndDate%
- WaitTime = 2 (秒)
```

### 2. TARGETの起動
```
アクション: アプリケーションの実行
- アプリケーションパス: %TargetExePath%
- ウィンドウスタイル: 最大化
- 起動後の待機: 5秒
```

### 3. ウィンドウのアクティブ化
```
アクション: ウィンドウにフォーカス
- ウィンドウタイトル: "TARGET*" (部分一致)
```

### 4. レース検索画面を開く
```
アクション: UI要素をクリック
- 要素: メニュー > レース検索
- 検出方法: 画像認識 または UI要素
- 待機: %WaitTime%秒
```

### 5. 開始日の入力
```
アクション: UI要素にテキストを入力
- 要素: 開始日入力フィールド
- テキスト: %StartDate%
- 入力前にクリア: はい
- 待機: %WaitTime%秒
```

### 6. 終了日の入力
```
アクション: UI要素にテキストを入力
- 要素: 終了日入力フィールド
- テキスト: %EndDate%
- 入力前にクリア: はい
- 待機: %WaitTime%秒
```

### 7. 検索実行
```
アクション: UI要素をクリック
- 要素: 検索ボタン
- 待機: 5秒（検索結果の読み込み）
```

### 8. 全レース選択
```
アクション: UI要素をクリック
- 要素: 全選択ボタン
- 待機: %WaitTime%秒
```

### 9. 時系列オッズダウンロード
```
アクション: UI要素をクリック
- 要素: ファイルメニュー > 時系列オッズのダウンロード
- 待機: 30秒（ダウンロード完了まで）

※ レース数により待機時間を調整
```

### 10. CSV出力画面を開く
```
アクション: UI要素をクリック
- 要素: 出馬表レース選択画面 > CSV出力
- 待機: %WaitTime%秒
```

### 11. CSV出力実行
```
アクション: UI要素をクリック
- 要素: CSV出力実行ボタン
- 待機: 10秒（出力完了まで）
```

### 12. 完了確認
```
アクション: 条件分岐
- 条件: 出力フォルダにCSVファイルが存在する
- 真の場合: ログ記録「成功」
- 偽の場合: エラーハンドリング
```

### 13. TARGETの終了（オプション）
```
アクション: ウィンドウを閉じる
- ウィンドウタイトル: "TARGET*"
```

## エラーハンドリング

### UI要素が見つからない場合
```
Try-Catch ブロック:
  Try:
    - UI要素の操作
  Catch:
    - スクリーンショット保存
    - エラーログ記録
    - 通知メール送信（オプション）
    - フロー終了
```

### タイムアウト処理
```
各待機処理に最大待機時間を設定:
- 検索結果読み込み: 最大60秒
- ダウンロード: 最大300秒（5分）
- CSV出力: 最大60秒
```

## 実装手順

### Phase 1: レコーダーで基本操作を記録
1. Power Automate for Desktopを起動
2. 「新しいフロー」作成
3. 「デスクトップレコーダー」を起動
4. TARGETで手動操作を実行（上記手順2-11）
5. レコーダー停止
6. 記録されたアクションを確認

### Phase 2: フローの編集
1. 変数を入力パラメータに変更
2. 待機時間を調整
3. エラーハンドリングを追加
4. 条件分岐を追加

### Phase 3: テスト
1. 短期間（1日分）でテスト実行
2. ログを確認
3. 出力CSVを確認
4. エラーケースをテスト

### Phase 4: 本番運用
1. 長期間のデータ取得
2. スケジュール実行設定
3. 監視とメンテナンス

## UI要素の識別方法

Power Automate for Desktopでは以下の方法でUI要素を識別:

### 推奨: UI要素セレクター
- 自動生成されるセレクター文字列を使用
- 最も安定した方法

### 代替: 画像認識
- UI要素が動的に変わる場合
- セレクターが使えない場合

### 座標指定（非推奨）
- 解像度依存のため避ける
- 最終手段としてのみ使用

## スケジュール実行設定

### タスクスケジューラ経由
```powershell
# Power Automate フローをコマンドラインから実行
PAD.Console.Host.exe /run "TARGET時系列オッズ自動取得" /variables "StartDate:2024/01/01,EndDate:2024/01/31"
```

### 定期実行例
- 毎週月曜日 AM 2:00
- 前週のデータを取得
- 結果をログファイルに記録

## 出力ファイル

### CSVファイル命名規則
TARGET側の設定に依存:
- `レースID_時系列オッズ.csv`
- または一括出力ファイル

### ログファイル
```
output/
├── logs/
│   ├── 20240101_success.log
│   ├── 20240108_success.log
│   └── 20240115_error.log
└── csv/
    ├── 2024010607010101.csv
    ├── 2024010607010102.csv
    └── ...
```

## 保守・運用

### 定期メンテナンス
- [ ] 月次: UI要素セレクターの確認
- [ ] 月次: エラーログのレビュー
- [ ] 四半期: TARGETバージョンアップ時の動作確認

### トラブルシューティング
1. UI要素が見つからない → セレクターを再取得
2. タイムアウト → 待機時間を延長
3. CSV出力されない → TARGET設定を確認

## 参考資料

- [Power Automate for Desktop ドキュメント](https://learn.microsoft.com/ja-jp/power-automate/desktop-flows/)
- [UI自動化のベストプラクティス](https://learn.microsoft.com/ja-jp/power-automate/desktop-flows/ui-automation-best-practices)
